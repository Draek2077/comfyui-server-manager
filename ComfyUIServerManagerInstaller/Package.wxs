<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  This is the main WiX configuration file for your installer.
  You will replace the contents of your existing Package.wxs with this code.
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

    <!-- 
        The <Package> element defines the overall installer. 
        - Name: The product name that appears in "Add or remove programs".
        - Manufacturer: Your name or your company's name.
        - Version: The version of your application.
        - UpgradeCode: A unique GUID that identifies your application across different versions.
          IMPORTANT: You MUST generate a new GUID for this value. In Visual Studio, go to Tools > Create GUID.
      -->
    <Package Name="ComfyUI Server Manager"
             Manufacturer="Draekz"
             Version="1.0.0.0"
             UpgradeCode="08f8d139-35b0-48b8-bd51-ddb511922375">
        <!-- Platform attribute removed for WiX v4; architecture is selected at build. -->

        <!-- This ensures that installing a newer version will automatically uninstall the old one. -->
        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

        <!-- This element tells WiX to embed the cabinet file inside the MSI. -->
        <MediaTemplate EmbedCab="yes" />

        <!-- 
              This section defines the core installation directory structure.
            -->
        <!-- FIX: Changed from ProgramFilesFolder to ProgramFiles64Folder to resolve the ICE80 error. -->
        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="!(bind.property.Manufacturer)\!(bind.property.ProductName)" />
        </StandardDirectory>

        <!-- 
              The <Feature> element groups the components to be installed. 
              For a simple installer, we only need one feature.
            -->
        <Feature Id="Main" Title="Main Feature" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
            <!-- FIX: Re-added the reference to the Shortcuts component group. -->
            <ComponentGroupRef Id="Shortcuts" />
        </Feature>
    </Package>

    <Fragment>
        <!-- 
              This ComponentGroup defines the files that will be installed.
              It points to the INSTALLFOLDER directory we defined above.
            -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <!-- 
                This Component represents your main application executable.
            -->
            <Component Id="MainExecutable" Guid="*" Bitness="always64">
                <!-- 
                    NOTE: The File Id and Name have been corrected to match the Source file name.
                    The hardcoded 'publish\' path is fragile. Using a binder variable is recommended, e.g.:
                    Source="!(bind.targetPath.ComfyUIServerManager)\ComfyUIServerManager.exe"
                -->
                <File Id="ComfyUIServerManager.exe"
                      Name="ComfyUIServerManager.exe"
                      Source="publish\ComfyUIServerManager.exe"
                      KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- 
            FIX: The shortcut and registry key have been moved back into a separate, per-user component
            to resolve the ICE57 error.
        -->
        <ComponentGroup Id="Shortcuts" Directory="ProgramMenuFolder">
            <Component Id="StartMenuShortcut" Guid="*">
                <Shortcut Id="StartMenuShortcut"
                          Name="ComfyUI Server Manager"
                          Description="A tray utility to manage the ComfyUI server."
                          Target="[#ComfyUIServerManager.exe]"
                          WorkingDirectory="INSTALLFOLDER"/>
                <RemoveFolder Id="RemoveStartMenuFolder" On="uninstall"/>
                <!-- This per-user registry key is now the KeyPath for this per-user component. -->
                <RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
    </Fragment>
</Wix>
